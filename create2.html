<script>
const photoUpload = document.getElementById('photo-upload');
const photoPreview = document.getElementById('photo-preview');
const previewImage = document.getElementById('preview-image');
const previewName = document.getElementById('preview-name');
const loadingIndicator = document.getElementById('loading-indicator');
const errorIndicator = document.getElementById('error-indicator');
const errorLog = document.getElementById('error-log');
const retryButton = document.getElementById('retry-button');

let retryImage = null;

photoUpload.addEventListener('change', async function () {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    retryImage = e.target.result;
    photoPreview.src = retryImage;
    photoPreview.classList.remove('hidden');
    generatePreview(retryImage);
  };
  reader.readAsDataURL(file);
});

retryButton.addEventListener('click', () => {
  if (retryImage) generatePreview(retryImage);
});

async function generatePreview(base64Image) {
  previewImage.classList.add('hidden');
  loadingIndicator.classList.remove('hidden');
  errorIndicator.classList.add('hidden');
  errorLog.classList.add('hidden');
  retryButton.classList.add('hidden');

  try {
    const response = await fetch('/api/facetomany', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: base64Image })
    });

    const data = await response.json();

    if (!response.ok) {
      const errorDetails = data.error || 'An unknown error occurred.';
      throw new Error(errorDetails);
    }

    if (!data.output) throw new Error('No output received from Replicate.');

    previewImage.src = data.output;
    previewImage.classList.remove('hidden');

  } catch (err) {
    errorIndicator.classList.remove('hidden');
    errorLog.textContent = err.message || String(err);
    errorLog.classList.remove('hidden');
    retryButton.classList.remove('hidden');
  } finally {
    loadingIndicator.classList.add('hidden');
  }
}

function updatePreviewName() {
  const nameInput = document.getElementById('child-name').value;
  previewName.textContent = nameInput || "Your Child's Name";
}
</script>
