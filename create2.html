<script>
const photoUpload = document.getElementById('photo-upload');
const photoPreview = document.getElementById('photo-preview');
const previewImage = document.getElementById('preview-image');
const previewName = document.getElementById('preview-name');

photoUpload.addEventListener('change', async function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function (e) {
    const base64Image = e.target.result;
    photoPreview.src = base64Image;
    photoPreview.classList.remove('hidden');
    previewName.textContent = "Generating magical avatarâ€¦";

    try {
      const replicateResponse = await fetch("https://api.replicate.com/v1/predictions", {
        method: "POST",
        headers: {
          "Authorization": "Token YOUR_REPLICATE_API_TOKEN",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          version: "e5a939eae5db05a69e5b8c4c56d404cba8787be160058ecf302d4d3b9fc7c7c3",
          input: {
            image: base64Image,
            style_name: "storybook"
          }
        })
      });

      const { id } = await replicateResponse.json();
      let outputUrl = null;
      while (!outputUrl) {
        await new Promise(r => setTimeout(r, 2500));
        const check = await fetch(`https://api.replicate.com/v1/predictions/${id}`, {
          headers: { "Authorization": "Token YOUR_REPLICATE_API_TOKEN" }
        });
        const checkJson = await check.json();
        if (checkJson.status === "succeeded") {
          outputUrl = checkJson.output;
        } else if (checkJson.status === "failed") {
          throw new Error("Avatar generation failed.");
        }
      }

      previewImage.src = outputUrl;
      previewImage.classList.remove('hidden');
      previewName.textContent = "Your Magical Avatar";

    } catch (err) {
      console.error("Error generating preview:", err);
      previewName.textContent = "Preview failed. Please try again.";
    }
  };
  reader.readAsDataURL(file);
});

function updatePreviewName() {
  const nameInput = document.getElementById('child-name').value;
  previewName.textContent = nameInput || "Your Child's Name";
}
</script>
